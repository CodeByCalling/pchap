rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAdmin() {
      // TODO: Replace with custom claims or specific UID check for higher security if available
      return request.auth != null && request.auth.token.email.matches('.*admin.*');
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Specific Admins for Sensitive Data (Annex C)
    function isSensitiveAdmin() {
      // Hardcoded email check as per previous requirements. 
      // Ideally move to Custom Claims in the future.
      return request.auth != null && request.auth.token.email in ['osher@pchap.org', 'connie@pchap.org', 'admin@pchap.org'];
    }

    // Applications Collection
    // Rules: Users can read/write ONLY their own doc. Admins can read/write all.
    match /applications/{userId} {
      // Create: Owner only
      allow create: if isOwner(userId);
      
      // Read: Owner OR Admin OR Pastor Token (Specific Use Case)
      // Note: Keeping pastor token logic to avoid breaking Endorsement System, 
      // but ensuring it remains strict (only with valid token query).
      allow read, list: if isOwner(userId) || isAdmin()
                        || (request.query.limit <= 1 && request.query.filters.pastorEndorsementToken != null);

      // Update: Owner OR Admin OR Pastor (via Token)
      allow update: if isOwner(userId) || isAdmin() || canEndorse();
        
      // Subcollection: Health Private (Annex C)
      // Rules: STRICT access. Only Owner and specific Admin UIDs.
      match /health_private/{docId} {
        allow read, write: if isOwner(userId) || isSensitiveAdmin();
      }
    }
    
    // Contributions Collection
    // Rules: Users can CREATE properties but NOT update 'status' (Admin only).
    match /contributions/{contributionId} {
      // Create: Owner only. Must set correct userId.
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // Read: Owner OR Admin
      allow read: if (request.auth != null && resource.data.userId == request.auth.uid) || isAdmin();
      
      // Update: Admin ONLY
      // Users are explicitly BLOCKED from updating functionality here.
      allow update: if isAdmin();
      
      // Delete: Admin ONLY
      allow delete: if isAdmin();
    }
    
    // Endorsements (Pastor System)
    match /endorsements/{endorsementId} {
       allow create: if request.auth != null; 
       allow read: if true; 
       allow update: if true; 
    }

    // Helper for pastor endorsement updates
    function canEndorse() {
      return existingData().pastorEndorsementStatus == 'pending' &&
             (request.resource.data.pastorEndorsementStatus == 'approved' || 
              request.resource.data.pastorEndorsementStatus == 'rejected') &&
             request.resource.data.diff(resource.data).affectedKeys()
               .hasOnly(['pastorEndorsementStatus', 'pastorEndorsementBy', 'pastorEndorsementAt', 'pastorEndorsementNotes', 'updatedAt', 'status']);
    }
    
    function existingData() {
      return resource.data;
    }
  }
}
